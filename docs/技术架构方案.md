# 在线知识笔记平台 - 技术方案

## 1. 项目概述
本项目是一个全栈知识管理平台，旨在提供高效的笔记记录、实时协作、知识整理与AI辅助创作功能。系统采用现代化的前后端分离架构，支持 Markdown 与富文本双模式编辑，集成了思维导图、画板等可视化工具，并深度接入 Coze AI 智能体以增强用户体验。

## 2. 核心技术栈

### 2.1 前端架构 (`notes-frontend`)
- **框架**: Next.js 14 (App Router) - 利用服务端组件 (RSC) 提升首屏性能与 SEO。
- **语言**: TypeScript - 全类型安全开发。
- **样式**: Tailwind CSS - 原子化 CSS，配合 `@tailwindcss/typography` 优化阅读体验。
- **编辑器**: Tiptap (基于 ProseMirror) - 无头富文本编辑器，支持自定义扩展。
- **可视化**: 
  - **画板**: Excalidraw - 手绘风格白板工具。
  - **思维导图**: 基于 D3.js 或相关库的自定义实现。
- **协作**: Yjs + y-websocket - 实现毫秒级多人实时协作。
- **状态管理**: React Hooks (Context API) + SWR (数据请求)。
- **AI 集成**: Server-Sent Events (SSE) 流式响应，对接 Coze API v2。
- **AI 助手**: 
  - **AI 宠物**: 悬浮式智能助手，支持上下文对话与记忆 (LocalStorage)。
  - **多文档聚合**: 基于向量检索的 RAG (Retrieval-Augmented Generation) 实现，支持跨文档自动摘要。

### 2.2 后端架构 (`notes-backend`)
- **框架**: NestJS - 模块化、依赖注入的 Node.js 框架。
- **语言**: TypeScript。
- **数据库**: MongoDB (Mongoose) - 灵活的文档存储，适合笔记类非结构化数据。
- **缓存**: Redis (Upstash/IoRedis) - 用于 WebSocket 状态同步、接口限流与热点数据缓存。
- **API 规范**: RESTful API，遵循 OpenAPI 3.0 标准。
- **实时服务**: WebSocket Gateway - 处理协作信令与状态广播。
- **核心模块**:
  - **SemanticModule**: 基于向量检索的语义搜索与智能推荐。
  - **AuditModule**: 操作审计日志记录。
  - **DashboardModule**: 仪表盘数据聚合。

### 2.3 基础设施
- **部署平台**: Vercel (前端) + Zeabur (后端/协作服务)。
- **服务架构**: 前后端分离，协作服务 (y-websocket) 独立部署。
- **监控**: 自研 RUM (Real User Monitoring) 客户端，采集 Web Vitals 指标。

## 3. 关键功能实现

### 3.1 实时协作
采用 Yjs CRDT (Conflict-free Replicated Data Type) 算法解决并发冲突。
- **前端**: `TiptapEditor` 初始化 `Y.Doc`，通过 `WebsocketProvider` 连接后端。
- **后端**: 独立的 `y-websocket` 服务，负责广播更新并持久化数据到 MongoDB。

### 3.2 AI 辅助创作与检索
本平台深度集成了 Coze AI 能力，通过 BFF (Backend for Frontend) 层进行代理转发与鉴权。

#### 3.2.1 AI 宠物助手
- **架构**: 
  - **前端**: `ChatWindow` 组件，使用 `FormData` 提交文本与图片。
  - **状态**: 利用浏览器 `localStorage` (`ai_pet_history`, `ai_pet_conversation_id`) 实现会话持久化，刷新页面不丢失上下文。
  - **通信**: 标准 `fetch` API 配合 `ReadableStream` 读取流式响应，实现逐字显示的打字机效果。
  - **多模态**: 支持上传图片进行视觉问答 (Visual Q&A)。

#### 3.2.2 智能检索 (RAG)
实现了基于 RAG (Retrieval-Augmented Generation) 的多文档聚合问答：
1. **向量化 (Embedding)**: 
   - 笔记创建/更新时，后端 `NotesService` 异步调用 `EmbeddingService`。
   - 将 `title + content` 截取前 8000 字符，调用 Coze/OpenAI Embedding 接口生成向量。
   - 结果存入 MongoDB `Note` 文档的 `embedding` 字段。
2. **向量检索**:
   - 使用 MongoDB Atlas Vector Search (`$vectorSearch` 聚合管道)。
   - 根据用户查询向量，计算余弦相似度，召回 Top-10 相关笔记。
   - 支持 **混合检索 (Hybrid Search)**: 结合全文检索 (`$text`) 与向量检索，优化关键词匹配精度。
   - **CJK 优化**: 针对中文查询，采用自定义分词策略（按助词/标点切分），解决 MongoDB 默认分词对中文支持不佳的问题。
3. **聚合生成**:
   - 将召回的笔记片段作为 Context 注入 Prompt。
   - 调用 LLM 生成综合摘要，并标注引用来源。

### 3.3 插件化编辑器
基于 Tiptap (ProseMirror) 构建的富文本编辑器，核心扩展如下：

- **ResourceEmbed (统一资源嵌入)**:
  - **功能**: 统一管理画板与思维导图的嵌入展示。
  - **实现**: 自定义 Node View (`ResourceEmbed.tsx`)。
  - **双模式**:
    - **预览模式**: 使用 `iframe` 加载 `/embed/{type}/{id}?readonly=true`，支持缩放查看。
    - **链接模式**: 降级为简单的超链接卡片，减少页面内存占用。
  - **交互**: 插入时自动创建资源 -> 异步获取 ID -> 插入节点。
- **AIWriter**: 
  - **BubbleMenu**: 选中白文本后弹出，提供 "润色"、"摘要" 功能。
  - **FloatingMenu**: 空行处悬浮，提供 "AI 续写" 入口。
- **Collaboration**: 
  - 集成 `y-websocket`，实现光标协同、内容实时同步。
  - 离线编辑支持：本地 `Y.Doc` 变更在重连后自动合并。

## 4. 安全设计
- **认证**: JWT (JSON Web Token) + Passport.js。
- **鉴权**: 基于角色的访问控制 (RBAC)，笔记级别的权限管理 (Owner/Editor/Viewer)。
- **防护**: 接口限流 (Rate Limiting)，CORS 策略，输入验证 (class-validator)。

## 5. 性能优化
- **构建优化**: Next.js 静态生成 (SSG) + 增量静态再生 (ISR)。
- **加载优化**: 路由懒加载，组件动态导入 (Dynamic Import)，如 `SearchFilterBar` 和 `SmartRecommendations`。
- **网络优化**: API 预连接 (`link rel="preconnect"`), DNS 预解析。
