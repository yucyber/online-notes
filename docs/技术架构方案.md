# 在线知识笔记平台 - 技术方案

## 1. 项目概述
本项目是一个全栈知识管理平台，旨在提供高效的笔记记录、实时协作、知识整理与AI辅助创作功能。系统采用现代化的前后端分离架构，支持 Markdown 与富文本双模式编辑，集成了思维导图、画板等可视化工具，并深度接入 Coze AI 智能体以增强用户体验。

## 2. 核心技术栈

### 2.1 前端架构 (`notes-frontend`)
- **框架**: Next.js 14 (App Router) - 利用服务端组件 (RSC) 提升首屏性能与 SEO。
- **语言**: TypeScript - 全类型安全开发。
- **样式**: Tailwind CSS - 原子化 CSS，配合 `@tailwindcss/typography` 优化阅读体验。
- **编辑器**: Tiptap (基于 ProseMirror) - 无头富文本编辑器，支持自定义扩展。
- **可视化**: 
  - **画板**: Excalidraw - 手绘风格白板工具。
  - **思维导图**: 基于 D3.js 或相关库的自定义实现。
- **协作**: Yjs + y-websocket - 实现毫秒级多人实时协作。
- **状态管理**: React Hooks (Context API) + SWR (数据请求)。
- **AI 集成**: Server-Sent Events (SSE) 流式响应，对接 Coze API v2。

### 2.2 后端架构 (`notes-backend`)
- **框架**: NestJS - 模块化、依赖注入的 Node.js 框架。
- **语言**: TypeScript。
- **数据库**: MongoDB (Mongoose) - 灵活的文档存储，适合笔记类非结构化数据。
- **缓存**: Redis (Upstash/IoRedis) - 用于 WebSocket 状态同步、接口限流与热点数据缓存。
- **API 规范**: RESTful API，遵循 OpenAPI 3.0 标准。
- **实时服务**: WebSocket Gateway - 处理协作信令与状态广播。
- **核心模块**:
  - **SemanticModule**: 基于向量检索的语义搜索与智能推荐。
  - **AuditModule**: 操作审计日志记录。
  - **DashboardModule**: 仪表盘数据聚合。

### 2.3 基础设施
- **部署平台**: Vercel (前端) + Zeabur (后端/协作服务)。
- **服务架构**: 前后端分离，协作服务 (y-websocket) 独立部署。
- **监控**: 自研 RUM (Real User Monitoring) 客户端，采集 Web Vitals 指标。

## 3. 关键功能实现

### 3.1 实时协作
采用 Yjs CRDT (Conflict-free Replicated Data Type) 算法解决并发冲突。
- **前端**: `TiptapEditor` 初始化 `Y.Doc`，通过 `WebsocketProvider` 连接后端。
- **后端**: 独立的 `y-websocket` 服务，负责广播更新并持久化数据到 MongoDB。

### 3.2 AI 辅助创作
- **架构**: 前端 -> Next.js Route Handler (代理/鉴权) -> Coze API。
- **流式处理**: 使用 `ReadableStream` 解析 SSE 数据，实现打字机效果。
- **功能**: 
  - **AI Writer**: 支持续写、润色、摘要生成。
  - **智能体调用**: 专门的 Coze 智能体用于生成思维导图结构。

### 3.3 插件化编辑器
基于 Tiptap 的扩展机制，实现了：
- **基础格式**: 粗体、斜体、标题、列表、表格等。
- **高级组件**: 
  - `ResourceEmbed`: 支持嵌入思维导图、画板，支持链接/预览双模式切换。
  - `CommentMark`: 选区评论功能。
  - `AIWriter`: 悬浮/气泡菜单集成的 AI 工具。
  - `FloatingMenu`: 智能悬浮菜单，提供 AI 续写快捷入口。

## 4. 安全设计
- **认证**: JWT (JSON Web Token) + Passport.js。
- **鉴权**: 基于角色的访问控制 (RBAC)，笔记级别的权限管理 (Owner/Editor/Viewer)。
- **防护**: 接口限流 (Rate Limiting)，CORS 策略，输入验证 (class-validator)。

## 5. 性能优化
- **构建优化**: Next.js 静态生成 (SSG) + 增量静态再生 (ISR)。
- **加载优化**: 路由懒加载，组件动态导入 (Dynamic Import)，如 `SearchFilterBar` 和 `SmartRecommendations`。
- **网络优化**: API 预连接 (`link rel="preconnect"`), DNS 预解析。
