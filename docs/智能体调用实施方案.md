# 在线笔记项目 · 智能体调用实施方案

## 目标
- 在现有代码栈（NestJS+MongoDB 后端，Next.js 前端）上，引入协作与权限（只读/可评论/可编辑）、邀请与链接分享、活动日志、版本回溯与恢复。
- 保持与项目约束一致：始终通过智能体完成操作；交付可验证的架构/API/UI/合规/质量/性能方案与落地路线。

## 编排总览（调用顺序）
1. `search`：代码审阅与落点定位（已执行）。
2. `backend-architect-api`：RBAC+ABAC架构与数据模型落地到 Nest 模块与 Schema。
3. `api-architect`：REST 契约与鉴权/分页/幂等/条件更新细则，生成错误码字典。
4. `frontend-architect`：路由/组件/状态与数据层设计，权限态 UI 与日志/版本视图。
5. `ui-chain-expert`：关键交互流程（邀请/权限变更/评论编辑切换/版本恢复）。
6. `ui-quality-inspector`：WCAG 2.1 AA 与像素级比对方案。
7. `product-compliance-auditor`：隐私与合规（数据最小化、邀请TTL与撤销、审计WORM、DSAR）。
8. `code-quality-coordinator`：版本锁定、分支与PR门禁、静态扫描与CI阻断。
9. `performance-optimizer`：FCP/LCP/API延迟与容量阈值、采集与优化路线。
10. `api-lifecycle-qa`：全链测试矩阵与上线判定。

## 每个智能体的调用提示词（贴合本仓库）
- `search`
  - 任务：审阅 `notes-backend/src/modules/*` 与 `notes-frontend/src/app/*`，输出框架、鉴权、schema/接口、路由与编辑器现状，列出改造入口与缺口。
  - 期望：关键文件与函数清单、落点路径与改造建议。

- `backend-architect-api`
  - 任务：在 NestJS+Mongoose 上设计 RBAC+ABAC 与数据模型：
    - 新增模块与表/集合：`permissions`、`invitations`、`audit`、`note_versions`、可选 `collaboration`。
    - 扩展 `users.schema.ts`（`roles[]/orgId/attributes`）、`notes.schema.ts`（`ownerId/collaborators/visibility/acl[]`）。
    - 缓存键/TTL与写后失效策略；Kafka/队列事件主题（如使用）。
  - 期望：ER/集合定义、索引、守卫与装饰器的落地方式、写路径审计注入点。

- `api-architect`
  - 任务：生成 REST 契约：邀请/接受/撤销、协作者列表与权限变更、活动日志与版本列表/差异/恢复；JWT 声明与 Scope；游标分页；`Idempotency-Key` 与 `ETag/If-Match`；错误码与速率限制。
  - 期望：端点表、请求/响应示例、错误码字典与分组、条件更新/冲突处理规范。

- `frontend-architect`
  - 任务：在 Next App Router 中规划路由、组件与状态：
    - 路由：`/activity`、`/versions/:id`、协作面板与邀请弹窗；列表与编辑页的权限态 UI；日志与版本虚拟化。
    - 数据：`SWR` 分层与失效策略；`Zustand` 切片（`user/ui/collab/note`）。
    - 性能：首屏关键CSS内联、分包与图片/字体优化。
  - 期望：组件清单与契约、状态切片与数据源、性能预算与监控上报方案。

- `ui-chain-expert`
  - 任务：输出交互原型与规范：邀请/接受/撤销、权限变更、编辑/评论切换、活动日志筛选与详情、版本比较与恢复；危险操作二次确认、原因必填与审计联动。
  - 期望：流程图、组件状态与文案、失败/弱网/离线路径。

- `ui-quality-inspector`
  - 任务：WCAG 2.1 AA 与像素级比对清单：对比度、键盘路径与焦点、ARIA最小集合、缩放与触控门槛、证据与缺陷分级。
  - 期望：检查表、自动化工具与人工复核流程、整改SLA与证据包模板。

- `product-compliance-auditor`
  - 任务：隐私/合规：数据最小化白名单与 DPIA、邀请 TTL≤72h 一次性与撤销通知、关键事件 WORM 与保留≥24月证据、DSAR入口与 30天SLA、跨境 SCC/TIA 与备案。
  - 期望：风险清单与整改路线、验收标准与法条映射。

- `code-quality-coordinator`
  - 任务：技术栈版本锁定（Node22/TS5.6/ESLint9/Prettier3）、分支策略与主干保护、PR模板与评审要点、静态扫描阈值（重复率/复杂度/异常/覆盖率）、CI阻断规则与密钥扫描。
  - 期望：《技术栈落地手册》与《代码协作规范》，CI门禁配置蓝图。

- `performance-optimizer`
  - 任务：定义前端与后端性能阈值与采集方案，提供压测分层（500/800/1000）与瓶颈优化序列（索引/N+1/缓存/池化/分包）。
  - 期望：监控阈值与报警条件、优化优先级、回归度量与发布策略。

- `api-lifecycle-qa`
  - 任务：编制并执行“功能/权限边界/幂等并发/性能/安全/兼容”测试矩阵；输出上线判定与灰度策略。
  - 期望：用例表、报告与缺陷台账、门槛达标结论。

## 落地文件与改造插入点
- 后端（绝对路径）
  - `c:\Users\34850\Desktop\online-notes\notes-backend\src\modules\auth\strategies\jwt.strategy.ts`
  - `c:\Users\34850\Desktop\online-notes\notes-backend\src\modules\users\schemas\user.schema.ts`
  - `c:\Users\34850\Desktop\online-notes\notes-backend\src\modules\notes\schemas\note.schema.ts`
  - `c:\Users\34850\Desktop\online-notes\notes-backend\src\modules\notes\notes.service.ts`
  - `c:\Users\34850\Desktop\online-notes\notes-backend\src\modules\notes\notes.controller.ts`
  - 新增模块目录：`permissions/`、`invitations/`、`audit/`、`note-versions/`、`collaboration/`
- 前端（绝对路径）
  - `c:\Users\34850\Desktop\online-notes\notes-frontend\src\lib\api.ts`
  - `c:\Users\34850\Desktop\online-notes\notes-frontend\src\lib\auth.ts`
  - `c:\Users\34850\Desktop\online-notes\notes-frontend\src\components\editor\MarkdownEditor.tsx`
  - `c:\Users\34850\Desktop\online-notes\notes-frontend\src\app\dashboard\notes\[id]\edit\page.tsx`
  - `c:\Users\34850\Desktop\online-notes\notes-frontend\src\app\dashboard\activity\page.tsx`（新增）
  - `c:\Users\34850\Desktop\online-notes\notes-frontend\src\app\dashboard\versions\[id]\page.tsx`（新增）
  - `c:\Users\34850\Desktop\online-notes\notes-frontend\src\components\collab\*`（新增）

## 验收门槛
- 授权正确性：越权100%拦截；角色矩阵与 ACL/ABAC 生效；邀请过期/撤销与一次性均通过测试。
- 版本恢复一致性：恢复生成新版本并可回滚；审计记录链式哈希可追溯。
- 活动日志完整性：事件可筛选并分页稳定；脱敏展示与导出权限。
- 性能与可用性：`API p95≤300ms`、`p99≤600ms`、`成功率≥99.9%`；前端 `p75 FCP≤2s/LCP≤3s/TBT≤200ms/CLS≤0.1`。
- 无障碍：WCAG 2.1 AA违例=0；像素比对保真≥95%。
- 合规：数据最小化矩阵与DPIA、WORM实施证据、DSAR入口与SLA、跨境机制与备案。
- 质量门禁：重复率<15%、核心圈复杂度≤12、未处理异常<5%、覆盖率后端≥80/75前端≥75/70、Sonar质量门禁通过、密钥扫描=0。

## 后续材料（需团队提供）
- 峰值QPS与并发、文档与附件最大体量、搜索实时性；数据库与框架最终选型；CI平台与扫描器；跨境数据流图与隐私文本。

