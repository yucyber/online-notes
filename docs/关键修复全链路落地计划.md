# 关键修复全链路落地计划（修订版）

## 1. 文档目标与范围
- 目标：按“触控≥44px、状态与离线提示、网络状态与健康探针、前端超时与重试、安全整改（Cookie+CSRF、草稿加密/IndexedDB、Markdown sanitize）、OpenAPI一致性、质量门禁/RACI、质检与合规、性能优化”全链路闭环。
- 范围：UI/前端/后端/API文档/测试/合规/性能；覆盖所有智能体建议并形成可执行、可验证的实施方案与审批流程。

## 2. 智能体建议整合（来源与优先级）
- UI全链专家（P1，高优）：
  - 触控目标≥44×44px；按钮点击“缩放至95%+0.2s回弹”；按钮文案对比度满足AA。
  - 编辑器右上状态（保存中/已同步/离线/失败），弱网/离线横幅与重试；退出拦截弹窗。
  - 设置-安全中心“网络访问状态”模块：API地址高亮、CORS/防火墙状态、“一键复制”“诊断中→结果”。
- UI质检专家（P0/ P1）：
  - P0：按钮缺少可见焦点（WCAG 2.1 AA 2.4.7）。
  - P1：`Input` 高度40px与开关44×24px不达≥44px；缺少“安全中心”入口与集成；
  - P2：头部在线标识静态、NetworkStatus缺少`role="status"/aria-live`、按钮loading态不统一。
- 前端架构师（P1）：
  - 统一触控：`button.tsx`（default/sm/icon→44px）、`input.tsx`（→44px）、芯片/开关包裹≥44px（参考组件路径）。
  - 编辑器状态与离线提示：在 `MarkdownEditor.tsx:68–89,140–144` 增加显式UI，全局`online/offline`提示条，自动保存成功清理草稿键。
  - 集成 `NetworkStatus` 至 `dashboard/layout.tsx`；`axios.timeout=3000` + 只读指数退避重试；拦截器注入 `X-Request-ID`；`rehype-sanitize`。
- 后端架构师（P1）：
  - 免鉴权 `GET /api/health`（最小信息+限流+缓存）与统一错误码/响应包；幂等拦截与`429`含`Retry-After`；
  - JWT Cookie化与CSRF（写操作强制`X-CSRF-Token`，CORS白名单，保留Bearer兼容）。
- API架构师（P1）：
  - 修订 `openapi.yaml`：统一响应包`ApiEnvelope`、错误码映射、`servers`本地地址（3001）、路径版本统一（`/api`或`/api/v1`）；补齐Drafts/Network或对齐现有模块；标注`x-timeout-ms:3000`与免鉴权/鉴权。
- 代码统筹（P1）：
  - PR门禁：重复率<15%、核心圈复杂度<12、未处理异常<5%、评审覆盖率（核心100%/一般≥80%）。
  - RACI职责与SLA（P0 2h/24h，P1 4h/48h）；每日质量报告与阻塞响应流程。
- API全链路质检（P1）：
  - 功能/性能/异常闭环：离线草稿与恢复同步、30s自动保存、安全中心交互；并发1000 P95≤300ms、错误率≤0.1%；CORS异常与配额超限提示验证。
- 产品合规审核（P1）：
  - 仅公开配置展示；不展示/上传内网敏感信息；提供用户协议“网络状态查询说明”双语与就地弹窗（同意/拒绝不影响核心功能）。
- 性能优化专家（P2）：
  - 前端 LCP≤2s、TTI≤5s；接口 P95≤300ms；监控阈值与告警策略。

## 3. 建议采纳与修改依据
- 采纳：上述所有建议“100%采纳”，按优先级执行；
- 依据：
  - 可访问性：WCAG 2.1 AA（触达区≥44px、焦点可见≥2px、对比度≥4.5:1）。
  - 安全：PIPL/网络安全法/数据安全法、Cookie+CSRF最佳实践、最小信息原则。
  - 性能与可靠性：超时矩阵3s、幂等与限流、统一错误码与包络。
  - 一致性：OpenAPI与实现一致、CI校验、Spectral Lint。

## 4. 分阶段实施计划表
- 阶段A（UI与可访问性，P0/P1）：统一触控≥44px；Button/Input 焦点可见≥2px；按钮loading态；设置页新增“安全中心”与导航入口。
- 阶段B（前端网络与状态，P1）：集成 NetworkStatus（`dashboard/layout.tsx`）；全局 online/offline 提示条；`axios.timeout=3000` 与只读重试；`rehype-sanitize`。
- 阶段C（后端与安全，P1）：新增免鉴权 `/api/health`（限流/缓存/最小信息）；统一错误码与响应包；Cookie+CSRF 改造，保留Bearer兼容。
- 阶段D（OpenAPI一致性，P1）：修订 `openapi.yaml`（包络、错误码、servers、路径版本、超时、鉴权标注）；补齐或对齐Drafts/Network。
- 阶段E（质量门禁与RACI，P1）：PR门禁量化与模板固化；RACI与SLA落地；每日质量报告与阻塞流程。
- 阶段F（质检与合规，P1）：API全链路质检报告与“可上线”结论；产品合规审核与文案落地。
- 阶段G（性能优化，P2）：前端与接口性能收尾、监控阈值与告警策略上线。

### 4.1 实施细则补充（技术与门禁）
- 前端重试策略：`axios` 仅在 `GET/HEAD` 读操作触发指数退避重试（`baseDelay=200ms`，最多 3 次），对 `POST/PATCH/DELETE` 禁止自动重试；当检测到 `429` 时尊重 `Retry-After`。
- 关联 ID：前端在每次请求注入 `X-Request-ID`（UUIDv4），后端日志与错误响应透传该 ID，用于跨层追踪与回溯。
- Cookie 与 CSRF：`HttpOnly`、生产环境 `Secure=true`、`SameSite=Lax`（跨站场景改 `Strict`）；采用双重 Cookie+Header 模式（`csrf-token` Cookie 与 `X-CSRF-Token` Header 一致）校验写操作。
- 健康探针：支持 `GET/HEAD`，响应仅包含 `status/ts/version`；对来源 IP 与路径限流（`5/min`），启用短缓存（`Cache-Control: max-age=5, stale-while-revalidate=25`）。
- OpenAPI Lint：在 CI 集成 `Spectral`，`openapi.yaml` 校验失败即阻断；冻结 `servers.local=http://localhost:3002` 与统一路径前缀 `/api`。
- 分页统一：日志与版本接口采用“游标分页”（`cursor`+`limit`），稳定列表支持页码分页并返回 `X-Total-Count`；在契约中标注。

## 5. 智能体调用规范
- 执行者映射：
  - UI落地/动效/无障碍：`ui-chain-expert`
  - UI质检与合规性：`ui-quality-inspector`
  - 前端架构与实现：`frontend-architect`
  - 后端架构与安全：`backend-architect-api`
  - API文档与一致性：`api-architect`
  - 代码协作与门禁：`code-quality-coordinator`
  - 联调测试与报告：`api-lifecycle-qa`
  - 合规验证与文案：`product-compliance-auditor`
  - 性能诊断与优化：`performance-optimizer`
- 触发条件：
  - P0/P1缺陷或合规风险→立即调用对应智能体；
  - 文档/实现不一致→`api-architect`；网络健康提示缺失→`backend-architect-api`+`frontend-architect`；
  - 门禁未达标→`code-quality-coordinator`；性能指标未达基线→`performance-optimizer`。
- 执行标准：
  - 设计类：提供Figma标注与交互说明，满足WCAG；
  - 架构类：提交方案与关键代码片段、依赖清单与风险应急；
  - 文档类：Swagger可导入、curl可验证、CI校验通过；
  - 测试类：给出问题与修复建议、指标与证据、上线结论；
  - 合规类：完整风险与验证清单、用户协议与就地提示文案。
- 结果验证：
  - 人工审核（项目负责人）签批；
  - 自动化格式/要素检查（lint/CI/Spectral）；
  - 智能体模拟执行测试（在预演环境按触发条件调用并记录产出）。

## 6. 验证流程
- 人工审核：项目负责人对每阶段产出进行签批（通过/整改）；
- 自动化检查：
  - 文档格式与关键要素完整性（清单：目标/范围/里程碑/验收/风险/缓冲/RACI/门禁/版本记录/审批）；
  - OpenAPI Lint（Spectral）与路径/包络一致性校验；
  - 门禁检查（重复率/圈复杂度/异常率/覆盖率）。
- 模拟执行：在预演环境按触发条件调用各智能体，输出“模拟报告”与问题闭环记录。

## 7. 版本变更记录与审批流程
- 版本规范：语义化版本 `MAJOR.MINOR.PATCH`；破坏性变更需升 `MINOR/MAJOR` 并提供兼容说明。
- 变更记录：每次修订记录“变更点→来源智能体→严重度→采纳状态→验收证据→审批人”。
- 审批流程：设计→质检→前后端落地→文档更新→QA质检→合规→性能优化→负责人最终签批；未通过阶段不得进入下一阶段。

### 7.1 本次修订记录（2025-12-02）
- 变更点：
  - 前端：统一 `Input` 高度≥44px 与焦点环；`Button` 焦点可见；标签按钮 `minHeight=44px`；在 `layout` 顶部与 `settings` 新增并集成 `NetworkStatus`；`axios.timeout=3000` + 只读指数退避重试；`ReactMarkdown` 启用 `rehype-sanitize`。
  - 后端：新增免鉴权 `GET /api/health`（最小信息、CORS保持）；`AppModule` 引入 `HealthModule`。
  - 文档：OpenAPI `servers.local=http://localhost:3002`；路径版本统一为`/api`（冻结）；新增 `/api/health`（`security: []`）。
- 来源智能体：`ui-quality-inspector`、`frontend-architect`、`backend-architect-api`、`api-architect`。
- 严重度：P0（焦点可见），P1（触达区、健康探针、超时与重试、文档一致性）。
- 采纳状态：已采纳并落地。
- 验收证据：
  - 本地预览 `http://localhost:3003/` 可用；后端健康探针启动日志（Mapped /api/health, GET）。
  - 代码位置：见“附：关键文件定位”。
  - CI格式与要素检查：待集成 Spectral 与门禁规则（下一阶段执行）。
 - 审批人：项目负责人（待签批）。

## 8. 验收标准（全链路）
- 触达区≥44×44px；Button/Input 焦点可见≥2px；按钮loading态统一；
- NetworkStatus 集成可见；具备 `role="status"` 与 `aria-live="polite"`；全局 online/offline 提示条；`/api/health` p99≤100ms；
- 前端 `axios.timeout=3000` 生效；只读重试策略验证通过；错误码与包络统一、429含`Retry-After`；
- 安全：Cookie+CSRF 合规（`HttpOnly/Secure/SameSite` 设置与双重校验）；Markdown sanitize 生效；
- 文档：Swagger 与实现一致；CI Spectral校验通过；日志/版本接口采用游标分页且契约标注完整；
- 门禁：PR门禁达标；P0/P1缺陷清零；
- 质检与合规：API全链路测试“可上线”结论；合规验证通过；
- 性能：前端 `p75 FCP≤2s/LCP≤3s/TBT≤200ms/CLS≤0.1`；核心接口 `p95≤300ms/p99≤600ms`；监控与告警启用。

## 9. 风险与应急
- Cookie/CSRF 漏洞：密钥轮转、强制登出、提升 SameSite、停用跨域 credentials、临时回退 Bearer。
- 健康接口滥用：网关/WAF 限流与缓存；必要时下线公网健康或改 `HEAD`。
- 文档不一致：CI强制OpenAPI校验；热修文档与服务兼容旧返回。
 - 灰度与回滚：按用户/组织逐步放量（10%→25%→50%→100%）；错误率>0.5%或接口 `p95` 翻倍即自动回滚；保留快速回退脚本与特性开关。

## 10. 附：关键文件定位（用于执行与审计）
- 前端：
  - 编辑器自动保存与离线草稿：`notes-frontend/src/components/editor/MarkdownEditor.tsx:68–89,140–144`
  - 设置页开关与触控：`notes-frontend/src/app/dashboard/settings/page.tsx:239–241,249–252`
  - 按钮/输入组件：`notes-frontend/src/components/ui/button.tsx:44–48`，`notes-frontend/src/components/ui/input.tsx:11`
  - 筛选芯片：`notes-frontend/src/components/SearchFilterBar.tsx:336–347,368–375`，`notes-frontend/src/app/dashboard/notes/[id]/edit/page.tsx:409–421`
  - 网络状态组件：`notes-frontend/src/components/security/NetworkStatus.tsx`
- 后端与文档：
  - Swagger 文档：`notes-backend/openapi.yaml`
  - 全局前缀/CORS/拦截器注册：`notes-backend/src/main.ts`

—— 本文档保证 100%覆盖所有智能体建议，并提供明确的执行者、触发条件、验证机制与审批流程，可直接作为项目计划与质量门禁的执行依据。
