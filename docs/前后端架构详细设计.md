# 前后端架构详细设计

## 1. 前端架构设计 (notes-frontend)

### 1.1 目录结构规范
- `src/app`: 页面路由 (App Router)。
  - `(auth)`: 登录/注册路由组。
  - `dashboard`: 核心工作台，包含笔记列表、编辑器、看板、思维导图等子路由。
  - `api`: Next.js Route Handlers (BFF层)，处理 AI 代理、文件上传等。
- `src/components`: UI 组件。
  - `editor`: Tiptap 编辑器相关 (Toolbar, Extensions, BubbleMenu)。
  - `collab`: 协作相关组件 (CollaboratorsPanel, CommentsPanel)。
  - `board`: Excalidraw 画板集成组件。
  - `mindmap`: 思维导图组件。
  - `ui`: 基础原子组件 (Button, Input, Dialog)。
  - `SearchFilterBar.tsx`: 高级搜索与筛选组件。
  - `SmartRecommendations.tsx`: 基于向量检索的智能推荐组件。
- `src/lib`: 核心逻辑库。
  - `api.ts`: Axios 封装与后端接口定义。
  - `yjs.ts`: 协作相关工具函数。
  - `ai-writer.ts`: AI 流式调用封装，支持 SSE (Server-Sent Events) 解析。
  - `coze.ts`: Coze API 调用封装 (思维导图生成)。
- `src/context`: 全局状态 (AuthContext, AIContext)。

### 1.2 核心模块设计
- **编辑器模块**: 
  - 采用 `TiptapEditor` 作为核心组件，通过 `useEditor` 钩子管理实例。
  - 自定义扩展 (`extensions/`) 实现业务逻辑，如 AI 写作、评论高亮、资源嵌入 (`ResourceEmbed`)。
  - 状态同步：通过 `onContentChange` 和 `onSelectionChange` 向上传递状态。
  - AI 集成：通过 `FloatingMenu` (续写) 和 `BubbleMenu` (润色/摘要) 提供交互入口。
- **协作模块**:
  - `WebsocketProvider` 负责与后端建立长连接。
  - 协作者光标：使用 `@tiptap/extension-collaboration-cursor` 渲染。
  - 离线支持：Yjs 支持离线编辑，重连后自动合并。
- **可视化模块**:
  - **画板**: 集成 `@excalidraw/excalidraw`，支持将画板数据序列化存储。
  - **思维导图**: 支持节点编辑、拖拽，数据结构与后端 `MindmapsModule` 同步。

## 2. 后端架构设计 (notes-backend)

### 2.1 模块划分 (Modules)
后端采用 NestJS 模块化设计，主要模块包括：
- **AuthModule**: 处理登录、注册、JWT 签发与校验。
- **UsersModule**: 用户资料管理。
- **NotesModule**: 笔记 CRUD，版本控制，权限校验。
- **Boards/MindmapsModule**: 画板与思维导图的数据持久化。
- **SemanticModule**: 向量检索与语义分析服务，负责笔记内容的 Embedding 和相似度计算。
- **AuditModule**: 记录关键操作日志（如删除笔记、修改权限）。
- **DashboardModule**: 聚合统计数据，提供仪表盘 API。
- **RumModule**: 接收前端性能监控数据。

### 2.2 数据模型 (Schema)
- **User**: `username`, `password` (hash), `email`, `avatar`.
- **Note**: 
  - `title`: 标题
  - `content`: HTML/JSON 内容
  - `owner`: 关联 User ID
  - `collaborators`: 协作者列表及权限
  - `category`: 关联 Category ID
  - `tags`: 关联 Tag ID 列表
  - `version`: 版本号
  - `embedding`: 向量数据 (用于语义搜索)
- **Comment**: 关联 Note ID, 选区位置, 内容, 作者。

### 2.3 接口设计规范
- **响应格式**: 统一使用 `{ code: 0, message: 'success', data: ... }`。
- **错误处理**: 全局异常过滤器 (`AllExceptionsFilter`) 捕获错误并标准化返回。
- **DTO**: 使用 `class-validator` 定义请求体结构，如 `CreateNoteDto`。

### 2.4 协作服务 (y-websocket)
- 独立部署的 Node.js 服务。
- 使用 `y-websocket` 库。
- 持久化层：自定义 `MongoAdapter` 或 `LevelDB`，将内存中的 Y.Doc 定期写入数据库。
- 鉴权：握手阶段校验 URL 参数中的 Token。

## 3. 数据流向
1. **用户操作**: 用户在编辑器输入字符。
2. **本地更新**: Tiptap 更新本地 DOM，Yjs 更新本地状态。
3. **同步**: Y-Websocket 通过 WS 发送增量更新 (Update) 到服务端。
4. **广播**: 服务端将更新广播给同一房间的其他客户端。
5. **持久化**: 服务端定期 (Debounce) 将合并后的文档快照存入 MongoDB。
6. **语义索引**: 笔记更新后，触发 `SemanticModule` 异步生成 Embedding 并更新向量索引。
