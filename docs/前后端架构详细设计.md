# 前后端架构详细设计

## 1. 前端架构设计 (notes-frontend)

### 1.1 目录结构规范
- `src/app`: 页面路由 (App Router)。
  - `(auth)`: 登录/注册路由组。
  - `dashboard`: 核心工作台，包含笔记列表、编辑器、看板、思维导图等子路由。
  - `api`: Next.js Route Handlers (BFF层)，处理 AI 代理、文件上传等。
    - `ai/pet`: AI 宠物助手对话接口。
    - `ai/mindmap`: 思维导图生成接口。
- `src/components`: UI 组件。
  - `editor`: Tiptap 编辑器相关 (Toolbar, Extensions, BubbleMenu)。
  - `collab`: 协作相关组件 (CollaboratorsPanel, CommentsPanel)。
  - `ai`: AI 相关组件。
    - `AIPet.tsx`: 悬浮宠物组件。
    - `ChatWindow.tsx`: 宠物对话窗口。
    - `AggregateSummaryDialog.tsx`: 多文档聚合摘要弹窗。
  - `board`: Excalidraw 画板集成组件。
  - `mindmap`: 思维导图组件。
  - `ui`: 基础原子组件 (Button, Input, Dialog)。
  - `SearchFilterBar.tsx`: 高级搜索与筛选组件。
  - `SmartRecommendations.tsx`: 基于向量检索的智能推荐组件。
  - `SummaryPreview.tsx`: (内部组件) 列表页摘要悬浮预览组件，支持防抖显示与滚动交互。
- `src/lib`: 核心逻辑库。
  - `api.ts`: Axios 封装与后端接口定义。
  - `yjs.ts`: 协作相关工具函数。
  - `ai-writer.ts`: AI 流式调用封装，支持 SSE (Server-Sent Events) 解析。
  - `coze.ts`: Coze API 调用封装 (思维导图生成)。
- `src/context`: 全局状态 (AuthContext, AIContext)。

### 1.2 核心模块设计
- **笔记详情页渲染策略 (RSC + Instant Preview)**:
  - **服务端 (`page.tsx`)**: 
    - 作为 Server Component 运行。
    - 从 Cookie 读取 Token，直接调用后端 API 获取笔记数据。
    - 处理 401 错误并自动重定向至登录页。
  - **客户端 (`NoteClientWrapper.tsx`)**:
    - 接收服务端传入的 `initialContent` (HTML)。
    - 在 Tiptap 编辑器加载前，使用 `dangerouslySetInnerHTML` 渲染静态 HTML，实现毫秒级首屏展示。
    - 编辑器加载完毕后，自动替换静态内容，激活协作与编辑功能。

- **编辑器模块 (`src/components/editor`)**: 
  - **TiptapEditor**: 核心组件，负责初始化 `Y.Doc` 和 `WebsocketProvider`。
  - **ResourceEmbed**: 
    - 路径: `extensions/ResourceEmbed.tsx`
    - 逻辑: 接收 `type` (mindmap/board) 和 `id`，渲染 `NodeViewWrapper`。内部维护 `displayMode` 状态，控制渲染 `iframe` 还是 `<a>` 标签。
    - 异常处理: `iframe` 加载失败 (`onError`) 时自动降级为文本链接。
  - **AI集成**: 
    - `streamAIWriter`: 封装 `fetch` + `TextDecoder`，处理流式响应。
- **AI 助手模块 (`src/components/ai`)**:
  - **ChatWindow**: 
    - 负责与 `/api/ai/pet` 通信。
    - 维护 `messages` 数组，支持图片上传 (`FileReader` 转 Base64 预览)。
    - 自动滚动 (`scrollIntoView`) 与 Markdown 渲染 (`react-markdown`)。
  - **AggregateSummaryDialog**: 
    - 调用 `notesAPI.aggregate` 获取聚合摘要。
    - 展示引用源列表 (Source Citations)。

## 2. 后端架构设计 (notes-backend)

### 2.1 模块划分 (Modules)
- **AiModule**:
  - **Service**: `AiService`
    - 封装 Coze API (`/open_api/v2/chat`) 调用。
    - 提供 `generateSummary` 方法，包含兜底逻辑（API 失败或未配置时截取前 200 字）。
- **NotesModule**: 
  - **Service**: `NotesService`
    - `create/update`: 
      - 1. 同步生成兜底摘要存入 `summary` 字段。
      - 2. 异步调用 `AiService.generateSummary` 生成高质量摘要并更新数据库。
      - 3. 触发 `updateEmbedding`，截取前 8000 字符生成向量。
    - `findAll`: 
      - **性能优化**: `.select('-content')`，不再查询正文，仅返回 `summary`，显著降低列表接口响应体积。
      - 集成 Redis 缓存。Key 生成策略: `notes:list:${userId}:${hash(queryParams)}`，TTL 10秒。
    - `aggregate`: 聚合查询入口，调用 `SemanticService`。
- **SemanticModule**: 
  - **Service**: `SemanticService`
    - `searchVector`: 执行 MongoDB `$vectorSearch`。
    - `search`: 实现混合检索逻辑。
      - **Keyword**: 使用 `$text` 索引。
      - **Vector**: 使用 Embedding。
      - **CJK处理**: 正则 `split` 切分中文句子，过滤停用词，优化分词效果。
- **Boards/MindmapsModule**: 
  - 提供 CRUD 接口，数据存储于 MongoDB。
  - 配合前端 `ResourceEmbed` 提供只读预览接口 `/embed/:type/:id`。

### 2.2 数据模型 (Schema)
- **Note**: 
  - `summary`: `string` (AI 生成的纯文本摘要，用于列表展示)。
  - `embedding`: `number[]` (索引: `vector_index`)。
  - `tags`: `ObjectId[]` (关联 Tag)。
  - `categoryIds`: `ObjectId[]` (支持多分类)。
- **Tag**: 
  - `noteCount`: `number` (去规范化字段，需通过 `syncCounts` 维护一致性)。

### 2.3 接口设计规范
- **响应格式**: 统一使用 `{ code: 0, message: 'success', data: ... }`。
- **错误处理**: 全局异常过滤器 (`AllExceptionsFilter`) 捕获错误并标准化返回。
- **DTO**: 使用 `class-validator` 定义请求体结构，如 `CreateNoteDto`。

### 2.4 协作服务 (y-websocket)
- 独立部署的 Node.js 服务。
- 使用 `y-websocket` 库。
- 持久化层：自定义 `MongoAdapter` 或 `LevelDB`，将内存中的 Y.Doc 定期写入数据库。
- 鉴权：握手阶段校验 URL 参数中的 Token。

## 3. 数据流向
1. **用户操作**: 用户在编辑器输入字符。
2. **本地更新**: Tiptap 更新本地 DOM，Yjs 更新本地状态。
3. **同步**: Y-Websocket 通过 WS 发送增量更新 (Update) 到服务端。
4. **广播**: 服务端将更新广播给同一房间的其他客户端。
5. **持久化**: 服务端定期 (Debounce) 将合并后的文档快照存入 MongoDB。
7. **AI 摘要**: 笔记更新后，触发 `AiModule` 异步生成摘要并更新 `summary` 字段。
6. **语义索引**: 笔记更新后，触发 `SemanticModule` 异步生成 Embedding 并更新向量索引。

### 3.2 AI 交互流程
1. **AI 宠物对话**:
   - 用户发送消息 -> 前端 `ChatWindow` -> `POST /api/ai/pet` -> Coze Bot。
   - 响应流式返回 -> 前端解析 SSE -> 实时渲染气泡。
   - 历史记录存储于浏览器 `localStorage`。
2. **多文档聚合**:
   - 用户触发聚合 -> 前端调用 `notesAPI.aggregate` -> 后端 `SemanticModule` 执行向量检索。
   - 后端获取 Top-K 相关笔记片段 -> 组装 Prompt -> 调用 LLM 生成摘要 -> 返回前端展示。
