# 系统持续开发完善方法

## 1. 开发工作流 (Workflow)

### 1.1 分支管理
- **main**: 主分支，对应生产环境，仅接受 Pull Request 合并。
- **develop**: 开发分支，日常开发合并目标。
- `feature/**`: 功能分支，如 `feature/ai-pet-assistant`。
- `fix/**`: 修复分支，如 `fix/cursor-bug`。

### 1.2 提交规范
遵循 Conventional Commits 规范：
- `feat`: 新功能
- `fix`: 修复 Bug
- `docs`: 文档变更
- `style`: 代码格式调整
- `refactor`: 代码重构
- `chore`: 构建过程或辅助工具变更

示例：`git commit -m "feat: 接入 AI 宠物助手与多文档聚合功能"`

## 2. 质量保障 (QA)

### 2.1 静态检查
- **Linting**: ESLint 配置在 `eslint.config.mjs`，提交前检查。
- **Type Check**: TypeScript 严格模式，运行 `tsc --noEmit` 验证类型。

### 2.2 测试策略
- **单元测试**: 
  - 运行 `npm run ci:test` 执行 Jest 测试。
  - 重点覆盖:
    - `__tests__/editor.markdown.spec.tsx`: Markdown 解析与渲染逻辑。
    - `__tests__/search.console.spec.tsx`: 搜索组件的状态流转与 RUM 上报。
- **API 测试**: 
  - `api-test/` 目录下存放 JSON 测试用例（如 `auth.json`, `note.json`）。
  - 建议使用 Postman 或类似工具导入这些定义进行接口验证。
- **预发布检查**: 
  - 运行 `scripts/predeploy-check.ps1`。
  - 该脚本会自动执行：
    1. 前端构建 (`npm run build`)
    2. 后端构建
    3. 类型检查 (`tsc --noEmit`)
    4. 单元测试

## 3. 持续集成/部署 (CI/CD)

### 3.1 本地构建检查
在提交代码前，务必运行：
```powershell
./scripts/predeploy-check.ps1
```
该脚本会执行全量检查，确保没有编译错误或测试失败。

### 3.2 部署流程
- **前端**: 
  - 推送至 GitHub `main` 分支。
  - Vercel 自动触发构建与部署。
  - 环境变量需在 Vercel Dashboard 配置 (如 `NEXT_PUBLIC_API_URL`, `COZE_API_KEY`)。
- **后端/协作**: 
  - Zeabur 监听主分支变更，自动拉取代码并重新构建服务。
  - 确保 Redis 服务正常运行，用于 WebSocket 状态同步与 API 缓存。

### 3.3 常用运维脚本
- **数据迁移**:
  - `scripts/generate-summaries.ts`: 遍历数据库中缺少摘要的笔记，批量调用 AI 生成摘要。适用于存量数据处理。
    - 用法: `cd notes-backend && npx ts-node scripts/generate-summaries.ts`

## 4. 监控与反馈
- **RUM 监控**: 
  - 前端集成了 RUM 客户端，收集 FCP, LCP, CLS 等性能指标。
  - 搜索行为监控: `search:trigger`, `search:result` 事件会上报至后端 `RumModule`，用于分析搜索质量。
- **日志**: 
  - 后端使用 NestJS Logger 记录关键操作与异常。
  - 生产环境建议接入日志聚合系统 (如 ELK 或 Datadog)。

## 5. 迭代计划管理
- **文档维护**: 
  - `docs/` 目录是项目的知识库，包含架构设计、操作手册和迭代计划。
  - 每次功能变更后，应同步更新 `README.md`、`openapi.yaml` 以及相关的 `docs/*.md` 文件。
- **计划记录**: 使用 `docs/` 下的文档记录迭代计划（如 `关键修复全链路落地计划.md`）。
