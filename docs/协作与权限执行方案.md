# 在线笔记协作与权限执行方案（经各智能体审批）

## 项目范围与目标
- 实现共享/协作（只读/可评论/可编辑）、邀请与链接分享、活动日志、版本回溯与恢复。
- 可用性≥99.99%、API p95≤300ms；前端 p75 FCP≤2s/LCP≤3s；WCAG 2.1 AA与隐私合规达标。

## 架构与权限
- 模型：RBAC为主、ABAC为辅；资源域`notes/attachments/audit/search/admin`，操作`read/comment/edit/share/admin/audit-read/restore`。
- 角色：`owner/admin/editor/commenter/viewer/auditor`；危险操作需二次确认与审计原因。
- ABAC属性：`classification/org_id/ip_range/device_trust/time_window/expires_at/max_views`；机密文档仅在同组织且可信设备下开放。

## 数据模型与索引
- `notes(id,org_id,owner_id,title,classification,tags,status,created_at,updated_at)`；索引`org_id+updated_at`。
- `note_versions(id,note_id,version_no,storage_ref,diff_ref,created_by,created_at)`；唯一`note_id+version_no`。
- `note_ops_log(id,note_id,seq,actor_id,op_type,payload,applied_at)`；唯一`note_id+seq`。
- `share_acl(id,note_id,principal_type,principal_id,permission,attributes_json,expires_at)`；唯一组合`note_id+principal_type+principal_id`。
- `audit_log(id,org_id,actor_id,action,resource_type,resource_id,before_ref,after_ref,trace_id,created_at,prev_hash,entry_hash)`；链式哈希+WORM。
- `idempotency_keys(request_id,endpoint,status,result_ref,expires_at)`、`compensation_log(txn_id,event,status,retries,last_error,updated_at)`。

## 审计与版本回溯
- 所有写/权限/分享/恢复/导出均审计；最小化字段与脱敏视图。
- 保留不可变快照+可回放操作流；支持按版本或时间点恢复并入审计。
- WORM策略与保留≥24月；关键事件提供对象锁或存储证明。

## API规范
- 鉴权：`Authorization: Bearer {JWT}`；标准声明含`tenantId`与最小`scopes`。
- 邀请：`POST /notes/{id}/collaborators/invitations`（Idempotency-Key）；`POST /invitations/{token}/accept`；`DELETE /notes/{id}/collaborators/invitations/{invId}`。
- 协作：`GET /notes/{id}/collaborators`、`PATCH /notes/{id}/collaborators/{userId}/role`（If-Match+Idempotency）。
- 日志与版本：`GET /notes/{id}/activity`（游标分页）、`GET /notes/{id}/versions`、`GET /notes/{id}/diff?from&to`、`POST /notes/{id}/versions/{versionId}/restore`（强一致+限流）。
- 错误：HTTP + 子码（`INVITE_* / ROLE_* / VERSION_* / IDEMPOTENCY_*`）；条件更新冲突`412`。
- 分页：日志/版本必须游标分页；稳定集合可页码分页并返回`X-Total-Count`。
- 速率限制：邀请/恢复按`noteId`与`actorId`各`5/min`，超限`429`附`Retry-After`。

## 前端架构与页面
- 技术栈：React18+Vite5+TypeScript+React Router+SWR+Zustand；Sentry/Web Vitals/Storybook/Cypress/Jest。
- 路由：`/`仪表盘、`/notes`列表、`/notes/:id`编辑器、`/activity`日志、`/versions/:id`版本、`/collab`协作、`/settings`设置；全部懒加载与数据预取。
- 组件：`CollabModeSwitch/RoleSelector/SessionPresence/CommentThread/ActivityFeed/EventDetailDrawer/VersionTimeline/DiffViewer/RollbackConfirmModal`等。
- 状态与数据：`user/ui/collab/note`切片；SWR去重/失效重验证/乐观更新/指数退避；ETag与If-None-Match。
- 性能：关键CSS内联≤3KB、bundle≤2MB、单资产≤300KB未压；图片WebP/AVIF、字体子集化与preload；虚拟列表与分段渲染。

## UI交互规范
- 邀请：弹窗输入（邮箱/用户名）、角色/有效期/备注；成功后可复制链接/重发/撤销；过期/撤销双向通知。
- 权限变更：成员行内下拉+差异摘要；高风险需二次确认与原因；不可移除最后管理员。
- 模式切换：顶部`编辑/评论`切换；编辑软锁与合并建议；评论浮动工具条与侧栏线程。
- 活动日志：筛选芯片（时间/操作者/事件/对象），时间线列表+抽屉详情（差异/trace/原因/导出）。
- 版本比较与恢复：差异视图（新增绿/删除红/修改黄）；恢复默认生成新版本并设为当前，未保存草稿先保存或生成副本。

## 可访问性与UI质量
- 对比度：文本≥4.5:1、大字≥3:1、非文本UI≥3:1；焦点线宽≥2px且对比≥3:1。
- 键盘：全路径可达，提供“跳到主要内容”；Tab顺序与视觉一致；对话框关闭焦点回到触发源。
- ARIA：角色/名称/值完整；`aria-expanded/controls/current`一致；错误`aria-describedby`联动。
- 缩放与触控：目标≥44×44px；200%–400%缩放无双向滚动；暗色模式与`prefers-reduced-motion`支持。
- 像素比对：间距±2px/半径±2px/阴影±4px/动画±50ms；红线叠加与偏差热图证据包。

## 隐私与合规
- 数据最小化：白名单`email/display_name`；日志脱敏（`email_hash`），不记录自由文本PII；DPIA与矩阵归档。
- 邀请安全：默认TTL≤72h、一次性、绑定受邀身份；即时撤销与通知；滥用阈值触发被动撤销。
- 审计与WORM：关键事件WORM与保留≥24月；提供实施证明；审计仅存最小字段与脱敏视图。
- DSAR与跨境：上线数据主体权利入口，30天SLA；跨境按SCC/TIA与本地备案执行。

## 代码规范与CI门禁
- 版本锁定：Node 22 LTS / npm 10 / TS 5.6 / ESLint 9 / Prettier 3；移除`^`漂移，启用`engines`。
- 分支：`main`保护；`feature/bugfix/hotfix/release`命名；上线前24h冻结非Bug。
- PR模板：摘要/需求链接/影响范围/风险与回滚/测试证明/错误码与API契约/灰度与监控。
- 阈值：重复率<15%、核心圈复杂度≤12、未处理异常<5%、ESLint Error=0、`npm audit`高危=0、覆盖率（后端≥80/75，前端≥75/70）、Sonar质量门禁通过。
- CI阻断：锁文件一致、Lint/Format一致、测试与覆盖率达标、Sonar通过、密钥扫描命中阻断、冻结窗口违规阻断、至少2人评审。

## 性能与容量
- 目标：`API p95≤300ms/p99≤600ms`、`成功率≥99.9%/超时≤0.5%`、`缓存命中≥80%`、`前端 TBT≤200ms/CLS≤0.1`、并发1000下稳定。
- 采集：RUM（FCP/LCP/CLS/TBT/INP）、APM与慢查、缓存命中与回源、压测（500/800/1000）。
- 优化：关键CSS内联、路由分包、图片/字体优化；索引与N+1治理、Cache-Aside与短TTL、池化与限流；金丝雀发布与自动回滚。
- 报警：`p75 FCP>2s`或`LCP>3s`、`API p95>300ms`或错误率>0.5%、`CPU>80%`持续、`缓存命中<80%`、`DB慢查>1s占比>1%`。

## 测试与验收
- 用例矩阵：功能/权限/幂等/并发/性能/安全/兼容；P0用例100%通过、P1≥95%。
- 安全：ZAP主动/被动、OWASP Top 10、上传白名单与病毒扫描、CSP/HSTS/CORS头断言；高危=0。
- 可访问性：axe/WAVE/Lighthouse线索+人工复核到WCAG AA；问题台账与证据包。
- 文档：错误码字典、分页/幂等/条件更新细则、监控指标字典与看板模板、隐私与合规声明。

## 风险控制与监控
- 滥用阈值：异常邀请>50/小时或导出>3次/小时触发封禁与审计；只读降级与熔断开关。
- 变更安全：保护型端点限流+审批；故障注入仅在测试；金丝雀与回滚脚本就绪。

## 交付物清单
- 架构与ER图、权限矩阵与策略、API端点与错误码字典、前端页面与组件规格、UI交互原型、WCAG审计报告、隐私与合规包（DPIA/政策/WORM证明/DSAR流程）、代码规范与CI配置、性能与监控方案、测试报告与上线判定。

## 未决与需提供资料
- 峰值QPS与并发在线编辑人数、单文档与附件大小上限、搜索实时性要求；后端数据库与框架实际选型；CI平台与扫描器；跨境数据流图与隐私文本。

